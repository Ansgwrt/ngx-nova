# site_type: lb

# ===== WebSocket 智能判断 =====
map $http_upgrade $connection_upgrade {
    default      "";
    websocket    "upgrade";
}


upstream {{.Domain | replace "." "_"}} {
    keepalive          320;
    keepalive_requests 500;
    keepalive_timeout  60s;
    {{- range .Backends }}
    server {{ . }};
    {{- end }}
}

# ===== HTTP → HTTPS =====
server {
    listen 80;
    listen [::]:80;

    server_name {{.Domain}};

    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    location / {
        return 301 https://$host$request_uri;
    }
}

# ===== HTTPS 443 =====
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    server_name {{.Domain}};

    access_log /var/log/nginx/{{.Domain}}-access.log main buffer=64k flush=10s;
    error_log /var/log/nginx/{{.Domain}}-error.log warn;

    acme_certificate letsencrypt;
    ssl_certificate $acme_certificate;
    ssl_certificate_key $acme_certificate_key;
    ssl_certificate_cache max=2;

    gzip on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
              application/json application/javascript application/xml
              application/rss+xml image/svg+xml;

    brotli on;
    brotli_comp_level 6;
    brotli_types text/plain text/css text/xml text/javascript
                 application/json application/javascript application/xml
                 application/rss+xml image/svg+xml;


    # ===== 静态资源 =====
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|bmp|swf|eot|svg|ttf|woff|woff2|webp)$ {
        proxy_pass http://{{.Domain | replace "." "_"}};

        # HTTP/1.1 持久连接
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # 超时控制
        proxy_connect_timeout 1s;
        proxy_send_timeout 2s;
        proxy_read_timeout 3s;

        # 故障转移配置
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_timeout 5s;
        proxy_next_upstream_tries 2;

        # 获取原始文件（禁用后端压缩）
        proxy_set_header Accept-Encoding "";
        #proxy_hide_header Vary;

        # 代理头
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Forwarded-Port   $server_port;

        # 缓存配置
        proxy_cache my_proxy_cache;
        proxy_cache_key "$scheme$host$request_uri$is_args$args";
        proxy_cache_valid 200 302 304 30d;
        proxy_cache_valid 404 1m;
        proxy_cache_valid any 10s;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        #proxy_ignore_headers Cache-Control Expires;

        # 性能优化
        expires 30d;
        etag on;
        sendfile on;
        tcp_nopush on;
        log_not_found off;
        access_log off;
    }

    # ===== 动态内容 =====
    location / {
        proxy_pass http://{{.Domain | replace "." "_"}};

        # 超时控制（比静态稍长）
        proxy_connect_timeout 2s;
        proxy_send_timeout 5s;
        proxy_read_timeout 8s;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 2;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection $connection_upgrade;

        # 代理头
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Forwarded-Port   $server_port;
    }
}
